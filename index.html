<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Raw WebGL Taxi Game</title>
<style>
  html,body{margin:0;padding:0;overflow:hidden;background:#000;font-family:sans-serif}
  #hud{position:absolute;top:10px;left:10px;color:#fff;background:rgba(0,0,0,.6);padding:8px 12px;border-radius:4px;font-size:14px}
</style>
</head>
<body>
<canvas id="gl"></canvas>
<div id="hud">
  <b>RAW WEBGL TAXI</b><br>
  W/S accelerate â€¢ A/D steer<br>
  Passengers: <span id="score">0</span>
</div>

<script>
// -------------------- CANVAS --------------------
const canvas = document.getElementById("gl");
function resize(){canvas.width=innerWidth;canvas.height=innerHeight}
resize(); onresize=resize;
const gl = canvas.getContext("webgl");

// -------------------- SHADERS --------------------
const vs = `
attribute vec3 aPos;
attribute vec3 aCol;
uniform mat4 uMVP;
varying vec3 vCol;
void main(){
  gl_Position = uMVP * vec4(aPos,1.0);
  vCol = aCol;
}`;
const fs = `
precision mediump float;
varying vec3 vCol;
void main(){ gl_FragColor = vec4(vCol,1.0); }`;

function compile(type,src){
  let s=gl.createShader(type);
  gl.shaderSource(s,src);
  gl.compileShader(s);
  return s;
}
let prog=gl.createProgram();
gl.attachShader(prog,compile(gl.VERTEX_SHADER,vs));
gl.attachShader(prog,compile(gl.FRAGMENT_SHADER,fs));
gl.linkProgram(prog);
gl.useProgram(prog);

// -------------------- MATRIX UTILS --------------------
function mul(a,b){
  let o=new Array(16);
  for(let i=0;i<4;i++)
    for(let j=0;j<4;j++)
      o[i*4+j]=a[i*4]*b[j]+a[i*4+1]*b[4+j]+a[i*4+2]*b[8+j]+a[i*4+3]*b[12+j];
  return o;
}
function ident(){return [1,0,0,0, 0,1,0,0, 0,0,1,0, 0,0,0,1]}
function trans(m,x,y,z){let t=ident();t[12]=x;t[13]=y;t[14]=z;return mul(m,t)}
function scale(m,x,y,z){let s=ident();s[0]=x;s[5]=y;s[10]=z;return mul(m,s)}
function rotY(m,a){
  let c=Math.cos(a),s=Math.sin(a);
  return mul(m,[c,0,-s,0, 0,1,0,0, s,0,c,0, 0,0,0,1]);
}
function perspective(fov,asp,n,f){
  let t=1/Math.tan(fov/2),o=new Array(16);
  o[0]=t/asp;o[1]=0;o[2]=0;o[3]=0;
  o[4]=0;o[5]=t;o[6]=0;o[7]=0;
  o[8]=0;o[9]=0;o[10]=(f+n)/(n-f);o[11]=-1;
  o[12]=0;o[13]=0;o[14]=(2*f*n)/(n-f);o[15]=0;
  return o;
}
function lookAt(e,c,u){
  let ex=e[0],ey=e[1],ez=e[2],
      cx=c[0],cy=c[1],cz=c[2],
      ux=u[0],uy=u[1],uz=u[2];
  let zx=ex-cx,zy=ey-cy,zz=ez-cz;
  let l=Math.hypot(zx,zy,zz); zx/=l; zy/=l; zz/=l;
  let xx=uy*zz-uz*zy,xy=uz*zx-ux*zz,xz=ux*zy-uy*zx;
  l=Math.hypot(xx,xy,xz); xx/=l; xy/=l; xz/=l;
  let yx=zy*xz-zz*xy,yy=zz*xx-zx*xz,yz=zx*xy-zy*xx;
  l=Math.hypot(yx,yy,yz); yx/=l; yy/=l; yz/=l;
  let o=ident();
  o[0]=xx;o[1]=yx;o[2]=zx;
  o[4]=xy;o[5]=yy;o[6]=zy;
  o[8]=xz;o[9]=yz;o[10]=zz;
  o[12]=-(xx*ex+xy*ey+xz*ez);
  o[13]=-(yx*ex+yy*ey+yz*ez);
  o[14]=-(zx*ex+zy*ey+zz*ez);
  return o;
}

// -------------------- GEOMETRY --------------------
function cube(size,r,g,b){
  let s=size/2;
  let p=[
    -s,-s, s,  s,-s, s,  s, s, s, -s, s, s,
    -s,-s,-s, -s, s,-s,  s, s,-s,  s,-s,-s,
    -s, s,-s, -s, s, s,  s, s, s,  s, s,-s,
    -s,-s,-s,  s,-s,-s,  s,-s, s, -s,-s, s,
     s,-s,-s,  s, s,-s,  s, s, s,  s,-s, s,
    -s,-s,-s, -s,-s, s, -s, s, s, -s, s,-s
  ];
  let idx=[
    0,1,2,0,2,3, 4,5,6,4,6,7,
    8,9,10,8,10,11, 12,13,14,12,14,15,
    16,17,18,16,18,19, 20,21,22,20,22,23
  ];
  let col=[];
  for(let i=0;i<24;i++) col.push(r,g,b);
  return {p,idx,col};
}
function ground(size){
  let s=size/2;
  return {
    p:[-s,0,-s, s,0,-s, s,0,s, -s,0,s],
    idx:[0,1,2,0,2,3],
    col:[0.1,0.1,0.1, 0.1,0.1,0.1, 0.1,0.1,0.1, 0.1,0.1,0.1]
  };
}

function build(m){
  let o={};
  o.p=gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER,o.p);
  gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(m.p),gl.STATIC_DRAW);

  o.c=gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER,o.c);
  gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(m.col),gl.STATIC_DRAW);

  o.i=gl.createBuffer();
  gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,o.i);
  gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(m.idx),gl.STATIC_DRAW);

  o.count=m.idx.length;
  return o;
}

let taxi = build(cube(1,1,0.9,0));
let passenger = build(cube(0.6,0.1,1,0.3));
let groundMesh = build(ground(60));

// -------------------- GAME STATE --------------------
let taxiX=0, taxiZ=0, taxiA=0, speed=0;
let maxSpeed=0.25, accel=0.01, friction=0.008, steer=0.04;
let passX=5, passZ=5;
let score=0;
const scoreEl=document.getElementById("score");

// -------------------- INPUT --------------------
let keys={KeyW:0,KeyS:0,KeyA:0,KeyD:0};
onkeydown=e=>{if(keys[e.code]!=undefined)keys[e.code]=1};
onkeyup=e=>{if(keys[e.code]!=undefined)keys[e.code]=0};

// -------------------- DRAW --------------------
let aPos=gl.getAttribLocation(prog,"aPos");
let aCol=gl.getAttribLocation(prog,"aCol");
let uMVP=gl.getUniformLocation(prog,"uMVP");

gl.enable(gl.DEPTH_TEST);

function bind(mesh){
  gl.bindBuffer(gl.ARRAY_BUFFER,mesh.p);
  gl.vertexAttribPointer(aPos,3,gl.FLOAT,false,0,0);
  gl.enableVertexAttribArray(aPos);

  gl.bindBuffer(gl.ARRAY_BUFFER,mesh.c);
  gl.vertexAttribPointer(aCol,3,gl.FLOAT,false,0,0);
  gl.enableVertexAttribArray(aCol);

  gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,mesh.i);
}

function draw(mesh,model,view,proj){
  let vp=mul(proj,view);
  let mvp=mul(vp,model);
  gl.uniformMatrix4fv(uMVP,false,new Float32Array(mvp));
  gl.drawElements(gl.TRIANGLES,mesh.count,gl.UNSIGNED_SHORT,0);
}

// -------------------- LOOP --------------------
function loop(){
  requestAnimationFrame(loop);

  // Movement
  if(keys.KeyW) speed+=accel;
  else if(keys.KeyS) speed-=accel*0.7;
  else{
    if(speed>0){speed-=friction;if(speed<0)speed=0}
    if(speed<0){speed+=friction;if(speed>0)speed=0}
  }
  speed=Math.max(-maxSpeed*0.5,Math.min(maxSpeed,speed));

  if(speed!=0){
    if(keys.KeyA) taxiA+=steer*(speed>0?1:-1);
    if(keys.KeyD) taxiA-=steer*(speed>0?1:-1);
  }

  taxiX+=Math.sin(taxiA)*speed;
  taxiZ+=Math.cos(taxiA)*speed;

  taxiX=Math.max(-28,Math.min(28,taxiX));
  taxiZ=Math.max(-28,Math.min(28,taxiZ));

  // Pickup
  let dx=taxiX-passX, dz=taxiZ-passZ;
  if(Math.hypot(dx,dz)<1){
    score++;
    scoreEl.textContent=score;
    passX=(Math.random()-0.5)*40;
    passZ=(Math.random()-0.5)*40;
  }

  // Camera
  let camX=taxiX-Math.sin(taxiA)*8;
  let camZ=taxiZ-Math.cos(taxiA)*8;
  let camY=5;

  let view=lookAt([camX,camY,camZ],[taxiX,0.5,taxiZ],[0,1,0]);
  let proj=perspective(Math.PI/3,canvas.width/canvas.height,0.1,200);

  gl.viewport(0,0,canvas.width,canvas.height);
  gl.clearColor(0.05,0.05,0.08,1);
  gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);

  // Ground
  bind(groundMesh);
  draw(groundMesh,ident(),view,proj);

  // Passenger
  bind(passenger);
  let m=ident();
  m=trans(m,passX,0.3,passZ);
  draw(passenger,m,view,proj);

  // Taxi
  bind(taxi);
  m=ident();
  m=trans(m,taxiX,0.5,taxiZ);
  m=rotY(m,taxiA);
  m=scale(m,1.4,0.7,2);
  draw(taxi,m,view,proj);
}

loop();
</script>
</body>
</html>
