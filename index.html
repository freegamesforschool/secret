<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pure CSS 3D Taxi Drift</title>
<style>
    html, body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #111;
        touch-action: none;
    }

    #camera {
        width: 100vw;
        height: 100vh;
        perspective: 900px;
        overflow: hidden;
        position: relative;
    }

    #world {
        width: 1px;
        height: 1px;
        transform-style: preserve-3d;
        position: absolute;
        left: 50%;
        top: 50%;
    }

    .road {
        position: absolute;
        width: 2000px;
        height: 40px;
        background: #333;
        transform-style: preserve-3d;
    }

    .building {
        position: absolute;
        width: 80px;
        height: 80px;
        background: #555;
        transform-style: preserve-3d;
    }

    #taxi {
        width: 40px;
        height: 80px;
        background: yellow;
        position: absolute;
        transform-style: preserve-3d;
    }

    .skid {
        width: 6px;
        height: 20px;
        background: rgba(0,0,0,0.6);
        position: absolute;
        transform-style: preserve-3d;
    }

    /* Mobile controls */
    #joystick {
        position: absolute;
        left: 20px;
        bottom: 20px;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        border: 2px solid #fff5;
        display: none;
    }

    #thumb {
        width: 60px;
        height: 60px;
        background: #fff5;
        border-radius: 50%;
        position: absolute;
        left: 45px;
        top: 45px;
    }

    #driftBtn {
        position: absolute;
        right: 20px;
        bottom: 40px;
        width: 90px;
        height: 90px;
        border-radius: 50%;
        background: #fff3;
        border: 2px solid #fff7;
        color: white;
        font-size: 20px;
        display: none;
        justify-content: center;
        align-items: center;
    }
</style>
</head>
<body>

<div id="camera">
    <div id="world"></div>
</div>

<div id="joystick"><div id="thumb"></div></div>
<div id="driftBtn">DRIFT</div>

<script>
const world = document.getElementById("world");

// --- CITY LAYOUT ---
for (let i = -5; i <= 5; i++) {
    let road = document.createElement("div");
    road.className = "road";
    road.style.transform = `translateX(-1000px) translateZ(${i*200}px) rotateX(90deg)`;
    world.appendChild(road);

    road = document.createElement("div");
    road.className = "road";
    road.style.transform = `translateZ(-1000px) translateX(${i*200}px) rotateX(90deg) rotateZ(90deg)`;
    world.appendChild(road);
}

// Buildings
for (let x = -5; x <= 5; x++) {
    for (let z = -5; z <= 5; z++) {
        if (Math.abs(x) < 2 && Math.abs(z) < 2) continue;
        const b = document.createElement("div");
        b.className = "building";
        b.style.transform = `translateX(${x*200}px) translateZ(${z*200}px) translateY(-80px)`;
        world.appendChild(b);
    }
}

// --- TAXI ---
const taxi = document.createElement("div");
taxi.id = "taxi";
world.appendChild(taxi);

// --- PHYSICS ---
let posX = 0, posZ = 0, rotY = 0;
let speed = 0, steering = 0;
let velX = 0, velZ = 0;

const accel = 0.4;
const friction = 0.1;
const steerSpeed = 2;
const driftFactor = 0.15;
const grip = 0.85;

// --- INPUT ---
const keys = { w:0, s:0, a:0, d:0, drift:0 };

document.addEventListener("keydown", e => {
    if (e.key === "w") keys.w = 1;
    if (e.key === "s") keys.s = 1;
    if (e.key === "a") keys.a = 1;
    if (e.key === "d") keys.d = 1;
    if (e.key === " ") keys.drift = 1;
});
document.addEventListener("keyup", e => {
    if (e.key === "w") keys.w = 0;
    if (e.key === "s") keys.s = 0;
    if (e.key === "a") keys.a = 0;
    if (e.key === "d") keys.d = 0;
    if (e.key === " ") keys.drift = 0;
});

// --- MOBILE DETECTION ---
const isMobile = /Mobi|Android|iPhone/i.test(navigator.userAgent);
const joy = document.getElementById("joystick");
const thumb = document.getElementById("thumb");
const driftBtn = document.getElementById("driftBtn");

let joyX = 0, joyY = 0;

if (isMobile) {
    joy.style.display = "block";
    driftBtn.style.display = "flex";

    joy.addEventListener("touchmove", e => {
        const t = e.touches[0];
        const rect = joy.getBoundingClientRect();
        const cx = rect.left + rect.width/2;
        const cy = rect.top + rect.height/2;

        joyX = (t.clientX - cx) / 60;
        joyY = (t.clientY - cy) / 60;

        joyX = Math.max(-1, Math.min(1, joyX));
        joyY = Math.max(-1, Math.min(1, joyY));

        thumb.style.left = (45 + joyX*40) + "px";
        thumb.style.top  = (45 + joyY*40) + "px";
    });

    joy.addEventListener("touchend", () => {
        joyX = joyY = 0;
        thumb.style.left = "45px";
        thumb.style.top = "45px";
    });

    driftBtn.addEventListener("touchstart", () => keys.drift = 1);
    driftBtn.addEventListener("touchend", () => keys.drift = 0);
}

// --- SKID MARKS ---
function addSkid(x, z, angle) {
    const s = document.createElement("div");
    s.className = "skid";
    s.style.transform =
        `translateX(${x}px) translateZ(${z}px) rotateY(${angle}deg)`;
    world.appendChild(s);
    setTimeout(() => s.remove(), 2000);
}

// --- GAME LOOP ---
function loop() {
    // Input mapping
    const forward = isMobile ? -joyY : (keys.w - keys.s);
    const turn = isMobile ? joyX : (keys.a - keys.d);

    // Speed
    speed += forward * accel;
    speed *= (keys.drift ? 0.95 : 0.9);

    // Steering
    steering = turn * steerSpeed;

    // Rotation
    rotY += steering * (speed/10);

    // Drift physics
    const rad = rotY * Math.PI/180;
    const fx = Math.sin(rad);
    const fz = Math.cos(rad);

    let targetVX = fx * speed;
    let targetVZ = fz * speed;

    velX = velX * grip + targetVX * (1-grip);
    velZ = velZ * grip + targetVZ * (1-grip);

    posX += velX;
    posZ += velZ;

    // Skid marks
    if (Math.abs(steering) > 0.5 && Math.abs(speed) > 1) {
        addSkid(posX - fx*20, posZ - fz*20, rotY);
    }

    // Apply transforms
    world.style.transform =
        `translateX(${-posX}px) translateZ(${-posZ}px) rotateY(${rotY}deg)`;

    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
